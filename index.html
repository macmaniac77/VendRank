<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Boathouse Vending ELO Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(to bottom, #1a202c, #2d3748); }
    .product-card { transition: transform 0.2s; }
    .product-card:hover { transform: scale(1.05); }
  </style>
</head>
<body class="dark:bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4 font-sans">
  <h1 class="text-4xl font-bold mb-6 text-blue-300">Boathouse Vending: Pick Your Favorite Snack!</h1>

  <div id="loading" class="text-lg text-gray-400 mb-4">Loading products...</div>
  <div id="voting-section" class="hidden flex flex-col items-center space-y-4 mb-6">
    <div class="flex space-x-4">
      <div id="product-1" class="product-card bg-gray-800 p-4 rounded-lg shadow-lg w-48 text-center">
        <img id="image-1" class="w-full h-32 object-cover rounded mb-2" alt="Product Image">
        <p id="name-1" class="text-xl font-semibold text-blue-300"></p>
        <p id="slot-1" class="text-sm text-gray-400"></p>
        <p id="price-1" class="text-sm text-gray-400"></p>
        <p id="sold-1" class="text-sm text-gray-400"></p>
        <p id="elo-1" class="text-sm text-gray-300 font-medium"></p>
        <button id="vote-1" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Vote</button>
      </div>
      <div class="flex items-center text-2xl font-bold text-gray-300">VS</div>
      <div id="product-2" class="product-card bg-gray-800 p-4 rounded-lg shadow-lg w-48 text-center">
        <img id="image-2" class="w-full h-32 object-cover rounded mb-2" alt="Product Image">
        <p id="name-2" class="text-xl font-semibold text-blue-300"></p>
        <p id="slot-2" class="text-sm text-gray-400"></p>
        <p id="price-2" class="text-sm text-gray-400"></p>
        <p id="sold-2" class="text-sm text-gray-400"></p>
        <p id="elo-2" class="text-sm text-gray-300 font-medium"></p>
        <button id="vote-2" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Vote</button>
      </div>
    </div>
    <div class="flex space-x-4">
      <button id="next-pair" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 hidden">Next Pair</button>
      <button id="leaderboard-btn" class="bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700">Show Leaderboard</button>
      <button id="add-product-btn" class="bg-yellow-600 text-white px-6 py-2 rounded hover:bg-yellow-700">Add Product</button>
    </div>
  </div>
  <div id="leaderboard" class="hidden bg-gray-800 p-4 rounded-lg shadow-lg w-full max-w-md mb-4">
    <h2 class="text-xl font-semibold text-blue-300 mb-2">Leaderboard</h2>
    <ul id="leaderboard-list" class="text-gray-300"></ul>
    <button id="close-leaderboard" class="mt-4 bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Close</button>
  </div>
  <div id="add-product-form" class="hidden bg-gray-800 p-4 rounded-lg shadow-lg w-full max-w-md mb-4">
    <h2 class="text-xl font-semibold text-blue-300 mb-2">Add a New Product</h2>
    <form id="product-form">
      <input type="text" id="product-name" placeholder="Product Name" class="w-full p-2 mb-2 bg-gray-700 text-white rounded" required>
      <input type="text" id="product-link" placeholder="Image Link (e.g., 3.png)" class="w-full p-2 mb-2 bg-gray-700 text-white rounded" required>
      <input type="number" id="product-price" placeholder="Price" step="0.01" class="w-full p-2 mb-2 bg-gray-700 text-white rounded" required>
      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Submit</button>
    </form>
    <button id="close-form" class="mt-4 bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Close</button>
  </div>
  <div id="message" class="mt-4 text-lg text-gray-400"></div>

  <script>
    const visualSlotToItemSlotMap = {
      1: "A1", 2: "A3", 3: "A5", 4: "A7",
      5: "B1", 6: "B3", 7: "B5", 8: "B7",
      9: "C1", 10: "C3", 11: "C5", 12: "C7",
      13: "D1", 14: "D2", 15: "D3", 16: "D4", 17: "D5", 18: "D7",
      19: "E1", 20: "E2", 21: "E3", 22: "E4", 23: "E5", 24: "E6", 25: "E7", 26: "E8",
      27: "F1", 28: "F3", 29: "F5", 30: "F7"
    };
  </script>

  <script>
    const baseSlotLayoutData = [
      {
        "slot_id": 1,
        "center_x": 185,
        "center_y": 121,
        "width": 112,
        "height": 102,
        "top_left_x": 129,
        "top_left_y": 70
      },
      {
        "slot_id": 2,
        "center_x": 320,
        "center_y": 119,
        "width": 112,
        "height": 102,
        "top_left_x": 264,
        "top_left_y": 68
      },
      {
        "slot_id": 3,
        "center_x": 451,
        "center_y": 121,
        "width": 112,
        "height": 102,
        "top_left_x": 395,
        "top_left_y": 70
      },
      {
        "slot_id": 4,
        "center_x": 588,
        "center_y": 120,
        "width": 112,
        "height": 102,
        "top_left_x": 532,
        "top_left_y": 69
      },
      {
        "slot_id": 5,
        "center_x": 184,
        "center_y": 247,
        "width": 112,
        "height": 102,
        "top_left_x": 128,
        "top_left_y": 196
      },
      {
        "slot_id": 6,
        "center_x": 320,
        "center_y": 249,
        "width": 112,
        "height": 102,
        "top_left_x": 264,
        "top_left_y": 198
      },
      {
        "slot_id": 7,
        "center_x": 453,
        "center_y": 248,
        "width": 112,
        "height": 102,
        "top_left_x": 397,
        "top_left_y": 197
      },
      {
        "slot_id": 8,
        "center_x": 586,
        "center_y": 250,
        "width": 112,
        "height": 102,
        "top_left_x": 530,
        "top_left_y": 199
      },
      {
        "slot_id": 9,
        "center_x": 182,
        "center_y": 383,
        "width": 112,
        "height": 102,
        "top_left_x": 126,
        "top_left_y": 332
      },
      {
        "slot_id": 10,
        "center_x": 320,
        "center_y": 384,
        "width": 112,
        "height": 102,
        "top_left_x": 264,
        "top_left_y": 333
      },
      {
        "slot_id": 11,
        "center_x": 452,
        "center_y": 385,
        "width": 112,
        "height": 102,
        "top_left_x": 396,
        "top_left_y": 334
      },
      {
        "slot_id": 12,
        "center_x": 586,
        "center_y": 385,
        "width": 112,
        "height": 102,
        "top_left_x": 530,
        "top_left_y": 334
      },
      {
        "slot_id": 13,
        "center_x": 155,
        "center_y": 531,
        "width": 59,
        "height": 53,
        "top_left_x": 125.5,
        "top_left_y": 504.5
      },
      {
        "slot_id": 14,
        "center_x": 228,
        "center_y": 530,
        "width": 59,
        "height": 53,
        "top_left_x": 198.5,
        "top_left_y": 503.5
      },
      {
        "slot_id": 15,
        "center_x": 293,
        "center_y": 529,
        "width": 59,
        "height": 53,
        "top_left_x": 263.5,
        "top_left_y": 502.5
      },
      {
        "slot_id": 16,
        "center_x": 357,
        "center_y": 531,
        "width": 59,
        "height": 53,
        "top_left_x": 327.5,
        "top_left_y": 504.5
      },
      {
        "slot_id": 17,
        "center_x": 452,
        "center_y": 500,
        "width": 112,
        "height": 102,
        "top_left_x": 396,
        "top_left_y": 449
      },
      {
        "slot_id": 18,
        "center_x": 581,
        "center_y": 506,
        "width": 112,
        "height": 102,
        "top_left_x": 525,
        "top_left_y": 455
      },
      {
        "slot_id": 19,
        "center_x": 156,
        "center_y": 616,
        "width": 59,
        "height": 53,
        "top_left_x": 126.5,
        "top_left_y": 589.5
      },
      {
        "slot_id": 20,
        "center_x": 226,
        "center_y": 616,
        "width": 59,
        "height": 53,
        "top_left_x": 196.5,
        "top_left_y": 589.5
      },
      {
        "slot_id": 21,
        "center_x": 290,
        "center_y": 618,
        "width": 59,
        "height": 53,
        "top_left_x": 260.5,
        "top_left_y": 591.5
      },
      {
        "slot_id": 22,
        "center_x": 354,
        "center_y": 617,
        "width": 59,
        "height": 53,
        "top_left_x": 324.5,
        "top_left_y": 590.5
      },
      {
        "slot_id": 23,
        "center_x": 417,
        "center_y": 620,
        "width": 59,
        "height": 53,
        "top_left_x": 387.5,
        "top_left_y": 593.5
      },
      {
        "slot_id": 24,
        "center_x": 484,
        "center_y": 620,
        "width": 59,
        "height": 53,
        "top_left_x": 454.5,
        "top_left_y": 593.5
      },
      {
        "slot_id": 25,
        "center_x": 550,
        "center_y": 621,
        "width": 59,
        "height": 53,
        "top_left_x": 520.5,
        "top_left_y": 594.5
      },
      {
        "slot_id": 26,
        "center_x": 613,
        "center_y": 620,
        "width": 59,
        "height": 53,
        "top_left_x": 583.5,
        "top_left_y": 593.5
      },
      {
        "slot_id": 27,
        "center_x": 186,
        "center_y": 727,
        "width": 112,
        "height": 102,
        "top_left_x": 130,
        "top_left_y": 676
      },
      {
        "slot_id": 28,
        "center_x": 319,
        "center_y": 725,
        "width": 112,
        "height": 102,
        "top_left_x": 263,
        "top_left_y": 674
      },
      {
        "slot_id": 29,
        "center_x": 449,
        "center_y": 725,
        "width": 112,
        "height": 102,
        "top_left_x": 393,
        "top_left_y": 674
      },
      {
        "slot_id": 30,
        "center_x": 586,
        "center_y": 730,
        "width": 112,
        "height": 102,
        "top_left_x": 530,
        "top_left_y": 679
      }
    ];
  </script>

  <!-- Canvas for Vending Machine Display -->
  <div id="vendingMachineDisplay" class="mb-6 shadow-lg rounded-lg">
    <canvas id="vendingMachineCanvas" width="985" height="985" style="border: 1px solid #4A5568;">
      Your browser does not support the HTML5 canvas tag.
    </canvas>
  </div>

  <script>
    let items = [];
    let dynamicSlotConfig = [];

    function generateDynamicSlotConfig(fetchedItems, layoutData, map) {
      const dynamicSlots = [];
      for (let i = 0; i < layoutData.length; i++) {
        const slotLayout = layoutData[i];
        const currentVisualSlotId = slotLayout.slot_id; // slot_id from baseSlotLayoutData
        const targetItemSlotCode = map[currentVisualSlotId];
        const itemInJson = fetchedItems.find(item => item.slot === targetItemSlotCode);

        if (itemInJson && targetItemSlotCode !== "D2") { // Assuming "D2" is an example of a designated empty slot
          dynamicSlots.push({
            id: itemInJson.id,
            name: itemInJson.name,
            centerX: slotLayout.center_x,
            centerY: slotLayout.center_y,
            width: slotLayout.width,
            height: slotLayout.height,
            imageSrc: 'images/' + itemInJson.id + '.png',
            visualSlotId: currentVisualSlotId,
            itemSlotCode: targetItemSlotCode
          });
        } else {
          dynamicSlots.push({
            isEmpty: true,
            centerX: slotLayout.center_x,
            centerY: slotLayout.center_y,
            width: slotLayout.width,
            height: slotLayout.height,
            visualSlotId: currentVisualSlotId,
            itemSlotCode: targetItemSlotCode // Store even if empty, for consistency or debugging
          });
        }
      }
      return dynamicSlots;
    }

    async function fetchItems() {
      try {
        const res = await fetch('/api/jsonbin', { method: 'GET' });
        if (!res.ok) throw new Error('Fetch failed');
        const data = await res.json();
        items = data.items;
        dynamicSlotConfig = generateDynamicSlotConfig(items, baseSlotLayoutData, visualSlotToItemSlotMap);
        
        // NEW: Call a function to initialize canvas after config is ready
        if (typeof initializeVendingMachineCanvas === 'function') {
            initializeVendingMachineCanvas(dynamicSlotConfig); 
        } else {
            console.error("initializeVendingMachineCanvas function not found");
        }

        displayPair(); // This updates the ELO voting UI
      } catch (e) {
        document.getElementById('message').textContent = 'Error loading products';
        document.getElementById('message').classList.add('text-red-500');
      }
    }
    async function updateItems() {
      try {
        const res = await fetch('/api/jsonbin', {
          method: 'PUT',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({items})
        });
        if (!res.ok) throw new Error('Update failed');
        // Assuming 'items' might have been updated in the backend and is implicitly re-synced
        // or the local 'items' array is the source of truth for the PUT and is already up-to-date.
        // If the PUT request returns the updated list of items, you'd update 'items' here first.
        // For now, we'll assume 'items' is current.
        dynamicSlotConfig = generateDynamicSlotConfig(items, baseSlotLayoutData, visualSlotToItemSlotMap);
        document.getElementById('message').textContent = 'Scores updated!';
        setTimeout(()=>{document.getElementById('message').textContent=''; displayPair();},1000);
      } catch (e) {
        document.getElementById('message').textContent = 'Error updating scores';
        document.getElementById('message').classList.add('text-red-500');
      }
    }
    function displayPair() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('voting-section').classList.remove('hidden');
      const [a,b] = getRandomPair();
      ['1','2'].forEach((i, idx)=> {
        const item = idx===0? a : b;
        document.getElementById('image-'+i).src = 'images/'+item.id+'.png';
        document.getElementById('name-'+i).textContent = item.name;
        document.getElementById('slot-'+i).textContent = 'Slot: '+(item.slot||'N/A');
        document.getElementById('price-'+i).textContent = 'Price: $'+item.price.toFixed(2);
        document.getElementById('sold-'+i).textContent = 'Sold: '+item.sold;
        document.getElementById('elo-'+i).textContent = 'ELO: '+item.elo;
        document.getElementById('vote-'+i).onclick = ()=>vote(a,b, idx===0?1:0);
      });
    }
    function getRandomPair() {
      let i=Math.floor(Math.random()*items.length);
      let j=Math.floor(Math.random()*items.length);
      while(j===i) j=Math.floor(Math.random()*items.length);
      return [items[i], items[j]];
    }
    function vote(winner, loser, outcome) {
      const K=32;
      const expW=1/(1+10**((loser.elo-winner.elo)/400));
      const expL=1/(1+10**((winner.elo-loser.elo)/400));
      winner.elo = Math.round(winner.elo+K*(outcome-expW));
      loser.elo = Math.round(loser.elo+K*((1-outcome)-expL));
      updateItems();
    }
    function showLeaderboard() {
      const lb=document.getElementById('leaderboard'), ul=document.getElementById('leaderboard-list');
      lb.classList.remove('hidden'); ul.innerHTML='';
      items.sort((a,b)=>b.elo-a.elo).forEach(item=>{
        const li=document.createElement('li');
        li.textContent = `${item.name}: ${item.elo} (Slot:${item.slot||'N/A'}, Sold:${item.sold})`;
        ul.appendChild(li);
      });
    }
    document.getElementById('next-pair').onclick=displayPair;
    document.getElementById('leaderboard-btn').onclick=showLeaderboard;
    document.getElementById('close-leaderboard').onclick=()=>document.getElementById('leaderboard').classList.add('hidden');
    document.getElementById('add-product-btn').onclick=()=>document.getElementById('add-product-form').classList.remove('hidden');
    document.getElementById('close-form').onclick=()=>document.getElementById('add-product-form').classList.add('hidden');
    document.getElementById('product-form').addEventListener('submit', async e=>{
      e.preventDefault();
      const name=document.getElementById('product-name').value;
      const link=document.getElementById('product-link').value;
      const price=parseFloat(document.getElementById('product-price').value);
      const id = items.length > 0 ? Math.max(...items.map(x => x.id)) + 1 : 1;
      const prod={id,name,elo:1500,slot:null,price,cost:price*0.5,sold:0};
      items.push(prod);
      await updateItems();
      drawVendingMachine(window.dynamicSlotConfig); // Redraw canvas to show new item if it's mapped
      document.getElementById('message').textContent='Product added!';
      document.getElementById('add-product-form').classList.add('hidden');
      document.getElementById('product-form').reset();
    });
    fetchItems();
  </script>

  <!-- Script for Vending Machine Canvas Overlay -->
  <script>
    // Vending machine product overlay logic is now initialized by initializeVendingMachineCanvas
    // which is called from the first script block after dynamicSlotConfig is ready.

    let canvasGlobalRef; // To make canvas accessible for click listener removal/re-addition if needed
    let ctxGlobalRef;    // To make context accessible for drawing outside initial load
    let loadedImagesGlobal = {}; // Cache for loaded images

    function drawVendingMachine(configToDraw) {
        if (!ctxGlobalRef || !canvasGlobalRef) {
            console.error("Canvas context not initialized for drawVendingMachine");
            return;
        }
        const ctx = ctxGlobalRef;
        const canvas = canvasGlobalRef;
        const baseImageSrc = 'images/s65lfts.png'; // Define base image src here or pass as param

        // Draw base image
        const baseImage = loadedImagesGlobal[baseImageSrc];
        if (baseImage) {
            ctx.drawImage(baseImage, 0, 0, canvas.width, canvas.height);
        } else {
            console.error('Base vending machine image failed to load. Cannot draw.');
            ctx.fillStyle = 'lightgrey';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'black';
            ctx.textAlign = 'center';
            ctx.font = '16px Arial';
            ctx.fillText('Error: Base image could not be loaded.', canvas.width / 2, canvas.height / 2);
            // Do not return if base image fails, try to draw products anyway or show placeholders
        }

        // Draw product images from the dynamic configuration
        configToDraw.forEach(slot => {
            if (slot.isEmpty || !slot.imageSrc) {
                // Optionally, draw a placeholder for empty or imageless slots
                // console.log('Skipping empty or imageless slot:', slot.visualSlotId);
                return; // Skip this slot
            }

            const productImage = loadedImagesGlobal[slot.imageSrc];
            if (productImage) {
                const drawX = slot.centerX - slot.width / 2;
                const drawY = slot.centerY - slot.height / 2;
                ctx.drawImage(productImage, drawX, drawY, slot.width, slot.height);
            } else {
                // This product image failed to load, or not yet loaded
                console.warn('Product image not loaded for slot:', slot.visualSlotId, 'expected at', slot.imageSrc);
                // Optionally, draw a placeholder for missing product images
                // const drawX = slot.centerX - slot.width / 2;
                // const drawY = slot.centerY - slot.height / 2;
                // ctx.fillStyle = 'rgba(200, 200, 200, 0.5)';
                // ctx.fillRect(drawX, drawY, slot.width, slot.height);
                // ctx.fillStyle = 'black';
                // ctx.fillText('N/A', slot.centerX, slot.centerY);
            }
        });
        console.log('Vending machine drawing complete with dynamic config.');
    }


    function initializeVendingMachineCanvas(currentDynamicSlotConfig) {
        const canvas = document.getElementById('vendingMachineCanvas');
        if (!canvas || !canvas.getContext) {
            console.error('HTML5 Canvas is not supported by your browser or the canvas element was not found.');
            const displayDiv = document.getElementById('vendingMachineDisplay');
            if (displayDiv) {
                displayDiv.innerHTML = '<p style="color:red;">Error: Canvas not supported. Please use a modern browser.</p>';
            }
            return;
        }
        canvasGlobalRef = canvas; // Store canvas reference
        ctxGlobalRef = canvas.getContext('2d'); // Store context reference
        
        const baseImageSrc = 'images/s65lfts.png';
        let imagesToLoad = [baseImageSrc];

        currentDynamicSlotConfig.forEach(slot => {
            if (!slot.isEmpty && slot.imageSrc) {
                imagesToLoad.push(slot.imageSrc);
            }
        });
        
        // Filter out duplicate image URLs to prevent redundant loading
        imagesToLoad = [...new Set(imagesToLoad)];

        let imagesLoadedCount = 0;
        const totalImagesToLoad = imagesToLoad.length;

        // Clear previously loaded images if re-initializing, except for the base image if desired
        // For simplicity, we are clearing all and reloading.
        // loadedImagesGlobal = { [baseImageSrc]: loadedImagesGlobal[baseImageSrc] }; // Option to preserve base image
        loadedImagesGlobal = {};


        function imageLoadedCallback(src, img) {
            imagesLoadedCount++;
            loadedImagesGlobal[src] = img;
            if (imagesLoadedCount === totalImagesToLoad) {
                console.log("All images loaded, drawing vending machine.");
                drawVendingMachine(currentDynamicSlotConfig); // Pass the config used for loading
            }
        }

        function imageErrorCallback(src) {
            console.error('Error loading image:', src);
            imagesLoadedCount++; 
            if (imagesLoadedCount === totalImagesToLoad) {
                console.log("Finished processing all images (some may have failed), drawing vending machine.");
                drawVendingMachine(currentDynamicSlotConfig); // Still attempt to draw
            }
        }

        if (totalImagesToLoad === 0) { // No images to load (e.g. no base image, no product images)
             console.warn("No images to load for vending machine canvas.");
             drawVendingMachine(currentDynamicSlotConfig); // Attempt to draw anyway (e.g. empty canvas or base image if logic changes)
             return;
        }
        
        imagesToLoad.forEach(src => {
            // Skip if image already loaded (e.g. base image from previous load)
            // This check is more relevant if loadedImagesGlobal is not fully cleared
            if (loadedImagesGlobal[src]) {
                imagesLoadedCount++;
                if (imagesLoadedCount === totalImagesToLoad) {
                     drawVendingMachine(currentDynamicSlotConfig);
                }
                return;
            }

            const img = new Image();
            img.onload = () => imageLoadedCallback(src, img);
            img.onerror = () => imageErrorCallback(src);
            img.src = src;
        });

        // Setup click listener - ensure it's added only once or managed if this function can be called multiple times
        // For now, assuming it's fine to re-add if items are reloaded, but a more robust approach
        // might involve removing an old listener before adding a new one.
        // However, the event listener uses global dynamicSlotConfig, so re-adding isn't strictly necessary
        // unless the canvas element itself is recreated.
        
        // Check if listener already exists to avoid multiple additions (simple check)
        if (!canvas.dataset.clickListenerAdded) {
            canvas.addEventListener('click', function(event) {
                const rect = canvas.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                const clickY = event.clientY - rect.top;
                let clickedSlot = null;

                // Use the GLOBAL dynamicSlotConfig for hit detection
                // This is important because dynamicSlotConfig can be updated by fetchItems/updateItems
                // after this listener is initially set up.
                for (const slot of window.dynamicSlotConfig || []) { // Use window.dynamicSlotConfig to ensure global scope
                    if (slot.isEmpty) continue; // Cannot click empty slots

                    const minX = slot.centerX - slot.width / 2;
                    const minY = slot.centerY - slot.height / 2;
                    const maxX = slot.centerX + slot.width / 2;
                    const maxY = slot.centerY + slot.height / 2;

                    if (clickX >= minX && clickX <= maxX && clickY >= minY && clickY <= maxY) {
                        clickedSlot = slot;
                        break;
                    }
                }

                if (clickedSlot) {
                    console.log('Clicked on slot (dynamic):', clickedSlot.id, clickedSlot.name, clickedSlot.imageSrc);
                    
                    // Access global `items` and `updateItems` from the first script block
                    if (typeof window.items !== 'undefined' && typeof window.updateItems === 'function') {
                        const targetItem = window.items.find(item => item.id === clickedSlot.id);

                        if (targetItem) {
                            targetItem.elo += 5; // Increment ELO score
                            console.log('Updated ELO for item', targetItem.id, targetItem.name, 'New ELO:', targetItem.elo);
                            
                            window.updateItems().then(() => {
                                // After items are updated (and dynamicSlotConfig is presumably rebuilt), redraw the canvas.
                                // Note: updateItems already calls generateDynamicSlotConfig.
                                // We need to ensure the canvas redraws with the *new* dynamicSlotConfig.
                                // The `initializeVendingMachineCanvas` would need to be called again if images change,
                                // or just `drawVendingMachine` if only ELO/text details change but images are the same.
                                // For simplicity, if updateItems causes a full refresh of items that might change images,
                                // then initializeVendingMachineCanvas should be called again.
                                // However, the original plan was to call initializeVendingMachineCanvas only from fetchItems.
                                // Let's assume for now that updateItems() will refresh the ELO part of the UI,
                                // and if the canvas needs a full redraw with potentially new images,
                                // that would be handled by a subsequent fetchItems or a more direct call to redraw.
                                // The prompt focuses on the click handler using the global dynamicSlotConfig.
                                // A simple redraw after ELO update:
                                if (typeof window.dynamicSlotConfig !== 'undefined') {
                                   drawVendingMachine(window.dynamicSlotConfig);
                                }

                                // Optional: Immediate feedback if item is on display or leaderboard is active
                                const product1NameEl = document.getElementById('name-1');
                                const product2NameEl = document.getElementById('name-2');
                                if (product1NameEl && product1NameEl.textContent === targetItem.name) {
                                    document.getElementById('elo-1').textContent = 'ELO: ' + targetItem.elo;
                                }
                                if (product2NameEl && product2NameEl.textContent === targetItem.name) {
                                    document.getElementById('elo-2').textContent = 'ELO: ' + targetItem.elo;
                                }
                                const leaderboardDiv = document.getElementById('leaderboard');
                                if (leaderboardDiv && !leaderboardDiv.classList.contains('hidden') && typeof window.showLeaderboard === 'function') {
                                    window.showLeaderboard();
                                }
                            });

                        } else {
                            console.error('Could not find item with ID:', clickedSlot.id, 'in ELO items array.');
                        }
                    } else {
                        console.error('ELO game "items" array or "updateItems" function is not accessible from canvas script.');
                    }
                }
            });
            canvas.dataset.clickListenerAdded = 'true'; // Mark that listener has been added
        }
    }
  </script>
</body>
</html>
